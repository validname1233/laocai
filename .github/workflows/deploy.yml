# 部署到服务器
name: Deploy to Server

on:
  # 手动触发
  workflow_dispatch:
  push:
    # 仅 main 分支触发
    branches:
      - "main"

jobs:
  build-and-deploy:
    # GitHub 托管 Runner
    runs-on: ubuntu-latest

    steps:
      # 拉取仓库代码
      - name: Checkout
        uses: actions/checkout@v6.0.2

      # 安装 JDK 25
      - name: Set up JDK 25
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: "25"

      # 设置 Gradle 环境与缓存
      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v5

      # 构建可执行 Jar
      - name: Build bootJar
        run: gradle bootJar

      # 统一产物文件名
      - name: Prepare app.jar
        run: |
          JAR_PATH=$(echo build/libs/*.jar)
          cp "$JAR_PATH" app.jar

      # 通过 SCP 上传部署文件
      - name: Upload files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          # 需要在仓库 Secrets 中配置：
          # SERVER_HOST / SERVER_USER / SERVER_PORT / SERVER_SSH_KEY / SERVER_SSH_KEY_PASSPHRASE(可选)
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          passphrase: ${{ secrets.SERVER_SSH_KEY_PASSPHRASE }}
          port: ${{ secrets.SERVER_PORT }}
          # 上传到服务器部署目录
          source: "app.jar,Dockerfile,docker-compose.yml"
          target: "/root/llbot/app/laocai"
          overwrite: true

      # 登录服务器并构建/启动容器
      - name: Deploy on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          # 与上面保持一致的 SSH 配置
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          passphrase: ${{ secrets.SERVER_SSH_KEY_PASSPHRASE }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            set -e
            # 进入部署目录并用 compose 重建
            cd /root/llbot/app/laocai
            docker compose up -d --build
